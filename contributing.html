<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Contributing - Rust ♡ Existing C++</title>


        <!-- Custom HTML head -->

        <meta name="description" content="autocxx — safe interop between Rust and existing C++">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Rust ♡ Existing C++</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/google/autocxx" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="how-to-contribute"><a class="header" href="#how-to-contribute">How to Contribute</a></h1>
<p>We'd love to accept your patches and contributions to this project. There are
just a few small guidelines you need to follow.</p>
<h2 id="contributor-license-agreement"><a class="header" href="#contributor-license-agreement">Contributor License Agreement</a></h2>
<p>Contributions to this project must be accompanied by a Contributor License
Agreement. You (or your employer) retain the copyright to your contribution;
this simply gives us permission to use and redistribute your contributions as
part of the project. Head over to <a href="https://cla.developers.google.com/">https://cla.developers.google.com/</a> to see
your current agreements on file or to sign a new one.</p>
<p>You generally only need to submit a CLA once, so if you've already submitted one
(even if it was for a different project), you probably don't need to do it
again.</p>
<h2 id="code-reviews"><a class="header" href="#code-reviews">Code reviews</a></h2>
<p>All submissions, including submissions by project members, require review. We
use GitHub pull requests for this purpose. Consult
<a href="https://help.github.com/articles/about-pull-requests/">GitHub Help</a> for more
information on using pull requests.</p>
<h2 id="community-guidelines"><a class="header" href="#community-guidelines">Community Guidelines</a></h2>
<p>This project follows <a href="https://opensource.google/conduct/">Google's Open Source Community
Guidelines</a>.</p>
<h2 id="directory-structure"><a class="header" href="#directory-structure">Directory structure</a></h2>
<ul>
<li><code>book</code> - you're reading it!</li>
<li><code>demo</code> - a very simple demo example</li>
<li><code>examples</code> - will gradually fill with more complex examples</li>
<li><code>parser</code> - code which parses a single <code>include_cpp!</code> macro. Used by both the macro
(which doesn't do much) and the code generator (which does much more, by means of
<code>engine</code> below)</li>
<li><code>engine</code> - all the core code for actual code generation.</li>
<li><code>macro</code> - the procedural macro which expands the Rust code.</li>
<li><code>gen/build</code> - a library to be used from <code>build.rs</code> scripts to generate .cc and .h
files from an <code>include_cxx</code> section.</li>
<li><code>gen/cmd</code> - a command-line tool which does the same.</li>
<li><code>src</code> (outermost project) - a wrapper crate which imports the procedural macro and
a few other things.</li>
</ul>
<h2 id="where-to-start-reading"><a class="header" href="#where-to-start-reading">Where to start reading</a></h2>
<p>The main algorithm is in <code>engine/src/lib.rs</code>, in the function <code>generate()</code>. This asks
<code>bindgen</code> to generate a heap of Rust code and then passes it into
<code>engine/src/conversion</code> to convert it to be a format suitable for input
to <code>cxx</code>.</p>
<p>However, most of the actual code is in <code>engine/src/conversion/mod.rs</code>.</p>
<p>At the moment we're using a slightly branched version of <code>bindgen</code> called <code>autocxx-bindgen</code>.
It's hoped this is temporary (see <a href="https://github.com/google/autocxx/issues/124">here</a>
for status.)</p>
<h2 id="how-to-develop"><a class="header" href="#how-to-develop">How to develop</a></h2>
<p>If you're making a change, here's what you need to do to get useful diagnostics etc.
First of all, <code>cargo run</code> in the <code>demo</code> directory. If it breaks, you don't get much
in the way of useful diagnostics, because <code>stdout</code> is swallowed by cargo build scripts.
So, practically speaking, you would almost always move onto running one of the tests
in the test suite. With suitable options, you can get plenty of output. For instance:</p>
<pre><code class="language-ignore">RUST_BACKTRACE=1 RUST_LOG=autocxx_engine=info cargo test --all test_cycle_string_full_pipeline -- --nocapture
</code></pre>
<p>This is especially valuable to see the <code>bindgen</code> output Rust code, and then the converted Rust code which we pass into cxx. Usually, most problems are due to some mis-conversion somewhere
in <code>engine/src/conversion</code>. See <a href="https://docs.rs/autocxx-engine/latest/autocxx_engine/struct.IncludeCppEngine.html">here</a> for documentation and diagrams on how the engine works.</p>
<p>You may also wish to set <code>AUTOCXX_ASAN=1</code> on Linux when running tests. To exercise all
the code paths related to generating both C++ and Rust side shims, you can set
<code>AUTOCXX_FORCE_WRAPPER_GENERATION=1</code>. The test suite doesn't do this by default because
we also want to test the normal code paths. (In the future we might want to
parameterize the test suite to do both.)</p>
<h2 id="reporting-bugs"><a class="header" href="#reporting-bugs">Reporting bugs</a></h2>
<p>Moved to <a href="reporting_bugs.html">its own document</a>.</p>
<h2 id="how-to-contribute-to-this-manual"><a class="header" href="#how-to-contribute-to-this-manual">How to contribute to this manual</a></h2>
<p>More examples in this manual are <em>very</em> welcome!</p>
<p>Because <code>autocxx</code> examples require both Rust and C++ code to be linked together,
a custom preprocessor is used for this manual. See one of the existing examples
such as in <code>index.md</code> to see how to do this.</p>
<h2 id="maintenance-responsibilities"><a class="header" href="#maintenance-responsibilities">Maintenance responsibilities</a></h2>
<p>autocxx is currently in maintenance mode. In future, it may undergo further
feature development, but for now the job is just to keep it stable
and functional.</p>
<p>Events may occur which nonetheless require changes:</p>
<ul>
<li>Changes to Rust</li>
<li>Changes to <code>bindgen</code></li>
<li>Pull requests raised against autocxx</li>
<li>Issues reported against autocxx</li>
</ul>
<p>Here's what to do. If issues are reported, encourage the reporter
to raise a PR with a minimized test case by pointing them at the
<a href="reporting_bugs.html">"reporting bugs"</a> page. This resolves all concerns about
reproducibility. autocxx is quite sensitive to the environment in which it
runs, e.g. standard library header files in use, and it's rare to be able
to reproduce a reporter's bug without them raising a reproducible test case
like this.</p>
<p>If CI starts to fail due to a Rust change (or,
if we <a href="https://github.com/google/autocxx/issues/124">manage to unfork bindgen, a bindgen change</a>)
then raise a pull request to fix it. (Most commonly CI starts to fail
because of more aggressive clippy lints).</p>
<p>For user-contributed pull requests, merge them if you can! For reproducible
bug reports, try to investigate them. A fair proportion of the bug reports
boil down to certain key known areas of technical debt or limitations,
described below, and you can mark them as a duplicate or similar.</p>
<p>autocxx tends to make a release every month or two, dependent on what changes
have been made. Ideally, autocxx would release after every single pull
request but the process takes about 15 minutes (see below) so it's not
that frequent.</p>
<h2 id="release-process"><a class="header" href="#release-process">Release process</a></h2>
<p>To make a new release of autocxx,</p>
<ul>
<li>First ensure there's green CI on github.</li>
<li>Check out <code>main</code> locally and ensure it's up to date with <code>origin/main</code>.</li>
<li>Make a new branch</li>
<li>Run <code>tools/upgrade-version.sh OLD NEW</code> where <code>OLD</code> is the previous
released version number, and <code>NEW</code> is the new version number.</li>
<li>Commit that and make a PR; ensure it passes tests on github CI.</li>
<li>If so, merge that PR, and update locally.</li>
<li>Run <code>tools/publish-all.sh</code>. This will do the actual <code>cargo publish</code>
for all the various crates.</li>
<li>On <a href="https://github.com/google/autocxx/releases">github releases</a>,
choose Draft a new release. Add a tag for <code>v0.X.Y</code>. Go through
the process to automatically create release notes.</li>
</ul>
<h2 id="rolling-bindgen"><a class="header" href="#rolling-bindgen">Rolling bindgen</a></h2>
<p>autocxx currently depends upon a fork of bindgen called <code>autocxx-bindgen</code>.
<a href="https://github.com/google/autocxx/issues/124">This issue</a> is an attempt
at entirely unforking bindgen. There are about 14 upstream PRs required;
we should work hard to make required changes to get them accepted,
because then this section becomes irrelevant and you'll never need to follow
these steps.</p>
<p>Otherwise, periodically, you'll need to merge bindgen into autocxx-bindgen.
<a href="https://github.com/adetaylor/rust-bindgen"><code>autocxx-bindgen</code> is kept in this repository</a>
in the <code>master</code> branch (which should be renamed eventually if we don't
unfork bindgen).</p>
<p>To update it,</p>
<ul>
<li>Check out the master branch of that repo</li>
<li>Make a new branch</li>
<li><code>git pull &lt;upstream repo&gt; main</code> (note that we use merge rather than
rebase)</li>
<li>Resolve conflicts and commit.</li>
<li>Push this branch to <a href="https://github.com/adetaylor/rust-bindgen">the autocxx-bindgen repo</a></li>
<li>Make a new branch of autocxx</li>
<li>Amend <a href="https://github.com/google/autocxx/blob/main/engine/Cargo.toml#L34"><code>engine/Cargo.toml</code></a>
to point to the new git branch of autocxx-bindgen instead of using
a published version (see the commented-out line)</li>
<li>Maybe <code>cd integration-tests; cargo test</code> to ensure things build and seem to
work... but you won't really know until you push to github CI</li>
<li>So, push your autocxx and make a pull request</li>
<li>If everything passes on CI, bump the <code>autocxx-bindgen</code> version number.
This needs to be done in <code>bindgen/Cargo.toml</code> and <code>Cargo.toml</code>. Commit that.</li>
<li>Push directly onto the master branch of
<a href="https://github.com/adetaylor/rust-bindgen">the autocxx-bindgen repo</a>.
You can't raise this roll as a pull request because Google's CLA tooling
will reject it.</li>
<li><code>cargo publish</code> the new autocxx-bindgen version.</li>
<li>Amend your <code>autocxx</code> PR to switch to the published <code>autocxx-bindgen</code> version,
and push that.</li>
<li>Ensure CI still passes.</li>
<li>If so, merge your <code>autocxx</code> PR.</li>
</ul>
<h2 id="major-areas-of-tech-debt"><a class="header" href="#major-areas-of-tech-debt">Major areas of tech debt</a></h2>
<p>The core of autocxx is the <code>Api</code> enum. That's solid. It's created by parsing
bindgen output, and exists all the way through to Rust and C++ codegen.
It is annotated by various analysis phases; it's parameterized by
the analysis phase so it's literally impossible to access those annotations
before they exist.</p>
<p>Because this core is solid, most of the areas of tech debt are discrete and
don't really overlap with each other. If you wish to tackle them, they
can be tackled fairly independently.</p>
<p>Without further ado, they are:</p>
<ol>
<li>
<p><strong>Naming</strong>. autocxx deals with lots of names - the original C++ name,
the name chosen by bindgen, the name we want to give to cxx, etc.
When one kind of name is used for another purpose, certain invariants
need to be applied, e.g. avoiding conflicting overloads, or avoiding
built-in cxx names such as <code>UniquePtr</code>. So, these different kinds of
names really need to be encapsulated in newtype wrappers which
enforce these invariants. This has been <a href="https://github.com/google/autocxx/issues/520">started here</a>.
The other tricky aspect here is that we deal with name conflicts in
two different ways. What are name conflicts? bindgen gives us
a hierarchical namespace which we have to map to a flat namespace to give
to cxx. For types, we just reject any duplicate names. For funtions, though,
we go to some efforts to rename them to be non-conflicting. We should
become uniform here by abstracting the name deconfliction stuff from the
function analysis.</p>
</li>
<li>
<p><strong>Fork of bindgen</strong>. As noted under <a href="#rolling-bindgen">rolling bindgen, above</a>,
we currently use a fork of bindgen called <code>autocxx-bindgen</code>. This carries
a maintenance burden as we roll upstream. Also as noted above, we're
making good progress on undoing this. Tracked
<a href="https://github.com/google/autocxx/issues/124">here</a>.</p>
</li>
<li>
<p><strong>Sensitivity to bindgen bugs caused by constructor calculations</strong>.
<code>bindgen</code> isn't perfect. When it mis-generates a type, users can
ask bindgen to mark that type as "opaque", in which case it's represented
as just an array of bytes. This is especially useful for complex templated
C++ types where bindgen still has a number of bugs. Unfortunately, users
of autocxx don't get that luxury. In order to calculate whether types
are movable, autocxx requires visibility into all the fields.
That means that any types marked opaque by bindgen are pretty useless,
and we never currently ask bindgen for opaque types.
<code>bindgen</code> might be in a better place to request implicit constructors,
then we can solve these problems. This is tracked
<a href="https://github.com/google/autocxx/issues/1461">here</a>.</p>
</li>
<li>
<p><strong><code>CppRef</code> and friends.</strong> <code>cxx</code> (and therefore <code>autocxx</code>) can be used
to create multiple mutable references to the same Rust memory.
This is UB. In cxx this problem applies only to types marked <code>Trivial</code>
since others are zero-sized. In <code>autocxx</code>, we give all types a size
so they can be allocated on the stack, and so the problem is worse.
(This is explained more
<a href="https://github.com/google/autocxx/blob/main/engine/src/conversion/codegen_rs/non_pod_struct.rs#L41">here</a>).
The intended solution here is to cease to use Rust references to
represent C++ references - instead using a newtype wrapper called
<code>CppRef&lt;T&gt;</code>. <code>autocxx</code> can already work in this mode using
<a href="https://docs.rs/autocxx/latest/autocxx/macro.safety.html"><code>unsafe_references_wrapped</code></a>
but for now it works well only on nightly Rust, pending the merge of the
<a href="https://github.com/rust-lang/rust/pull/135881">arbitrary self types v2 RFC</a>.
Even then, this isn't quite perfect because <code>cxx</code> expects to use
Rust references, and its key types (such as <code>cxx::UniquePtr</code>) provide
<code>Deref</code> implementations which point in that direction. This isn't a
huge problem but I mention it here because it's one of the very few
occasions in which our dependence on <code>cxx</code> is limiting for us.</p>
</li>
</ol>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="reporting_bugs.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="code-of-conduct.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="reporting_bugs.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="code-of-conduct.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->
        <script src="mermaid.min.js"></script>
        <script src="mermaid-init.js"></script>


    </div>
    </body>
</html>
